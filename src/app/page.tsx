"use client";
import { useState, useEffect } from "react";
import "@aws-amplify/ui-react/styles.css";
import { Amplify } from "aws-amplify";
import { withAuthenticator } from "@aws-amplify/ui-react";
import config from "../aws-exports"; // auto-generated by Amplify

import NavBar from "./components/NavBar";
import TaskList from "./components/TaskList";
import WelcomeModal from "./components/WelcomeModal";
import { useSubscription } from "./hooks/useSubscriptionStatus";

import { useFetchTasks } from "./hooks/useFetchTasks";
import { useMutateTasks } from "./hooks/useMutateTasks";
import { handleCreateUser } from "./hooks/useUser";

// Configure Amplify
const libraryOptions = { ssr: false };
Amplify.configure({ ...config, ...libraryOptions });

// ======== MAIN COMPONENT ========
function Home() {
  const [showWelcomeModal, setShowWelcomeModal] = useState(false);
  const { data: tasks = [], isLoading } = useFetchTasks();
  const { addTask, editTask, removeTask, clearTasks, bulkReplaceTasks } =
    useMutateTasks();

  const { handleSubscribe, isCreatingSession } = useSubscription();

  // Ensure the user record exists on mount
  useEffect(() => {
    handleCreateUser(setShowWelcomeModal);
  }, []);

  return (
    <div className="flex flex-col justify-center flex-1 min-h-0 p-4 w-full max-w-4xl">
      {/* NAV BAR at the top */}
      <NavBar />

      {/* Optional "Welcome" overlay if user is brand new */}
      {showWelcomeModal && (
        <WelcomeModal
          onClose={() => setShowWelcomeModal(false)}
          onSubscribe={handleSubscribe}
          isCreatingSession={isCreatingSession}
        />
      )}

      {/* MAIN CONTENT AREA */}
      <div className="flex flex-col items-center justify-start max-w-90 pt-8 flex-1 min-h-0">
        <TaskList
          tasks={tasks}
          isLoading={isLoading}
          onAddTask={addTask}
          onEditTask={editTask}
          onRemoveTask={removeTask}
          onClearAll={clearTasks}
          onSaveAiTasks={bulkReplaceTasks}
        />
      </div>

      {/* FOOTER at bottom */}
      {/* <Footer /> */}
    </div>
  );
}

// Export withAuthenticator if you want Amplifyâ€™s login flow
export default withAuthenticator(Home);
